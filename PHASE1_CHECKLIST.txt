# Phase 1 Implementation Checklist

## Week 1: Core Chat API

### Day 1: Database & LLM Setup
- [ ] Create database migration file (alembic revision)
- [ ] Add chat_messages table with all columns and indexes
- [ ] Add chat_feedback table with all columns
- [ ] Run migration (alembic upgrade head)
- [ ] Create backend/app/models/chat.py with ChatMessage and ChatFeedback models
- [ ] Update backend/app/models/__init__.py to import new models
- [ ] Add anthropic>=0.8.0 to requirements.txt
- [ ] Install dependencies (pip install -r requirements.txt)
- [ ] Add ANTHROPIC_API_KEY to .env file
- [ ] Test Anthropic API connection with simple script

**Deliverable**: Database tables exist, can save/query chat messages

---

### Day 2: LLM Integration
- [ ] Create backend/app/services/llm/ directory
- [ ] Create base.py with BaseLLMService abstract class
- [ ] Create claude.py with ClaudeService implementation
  - [ ] send_message() method works
  - [ ] Retry logic with exponential backoff
  - [ ] Timeout handling (10s)
  - [ ] Token counting
- [ ] Create factory.py with get_llm_service()
- [ ] Create openai.py stub (empty implementation for now)
- [ ] Write test script to send "Hello" message to Claude
- [ ] Verify response is received and formatted correctly

**Deliverable**: Can send messages to Claude API and get responses

---

### Day 3: Context Building & Prompts
- [ ] Create backend/app/services/chat/ directory
- [ ] Create context_builder.py with ContextBuilder class
  - [ ] _get_profile() fetches user data
  - [ ] _get_recent_transactions() fetches last 20 transactions
  - [ ] _get_signals() fetches behavioral signals
  - [ ] _get_recommendations() fetches approved recommendations
  - [ ] _get_spending_summary() calculates spending by category
  - [ ] _format_profile() formats user profile for LLM
  - [ ] _format_transactions() formats transactions for LLM
  - [ ] _format_signals() formats signals for LLM
  - [ ] _format_recommendations() formats recommendations for LLM
  - [ ] build_context() orchestrates all of the above
  - [ ] Token counting to stay under 8000 tokens
  - [ ] Truncates oldest data if exceeds limit
- [ ] Create prompts.py with SYSTEM_PROMPT_V1
  - [ ] Includes role definition
  - [ ] Includes capabilities
  - [ ] Includes limitations/guardrails
  - [ ] Includes tone guidance
  - [ ] Includes response format instructions
- [ ] Create build_user_message() template function
- [ ] Test context generation for sample user (user_bdb7b6912c0b)

**Deliverable**: Can build rich context from user data

---

### Day 4: Chat Endpoints (Backend)
- [ ] Create backend/app/api/chat.py with router
- [ ] Implement POST /chat/message endpoint
  - [ ] Validate user exists
  - [ ] Check user consent_status
  - [ ] Generate or use existing conversation_id
  - [ ] Save user message to database
  - [ ] Build context using ContextBuilder
  - [ ] Get conversation history (last 5 messages)
  - [ ] Call LLM service
  - [ ] Save assistant message to database
  - [ ] Return ChatResponse with all fields
  - [ ] Error handling (timeout, API error, invalid input)
  - [ ] Proper HTTP status codes (200, 400, 403, 500)
- [ ] Implement GET /chat/history/{user_id} endpoint
  - [ ] Returns conversations grouped by conversation_id
  - [ ] Pagination support (limit, offset)
  - [ ] Filter by conversation_id (optional)
  - [ ] Orders by timestamp DESC
- [ ] Implement DELETE /chat/history/{user_id} endpoint
  - [ ] Deletes messages for user
  - [ ] Can delete specific conversation_id
  - [ ] Returns count of deleted messages
  - [ ] Requires confirm=true param
- [ ] Implement POST /chat/feedback endpoint
  - [ ] Validates message_id exists
  - [ ] Validates rating 1-5
  - [ ] Saves feedback with optional text
  - [ ] Prevents duplicate feedback
- [ ] Register chat router in backend/app/main.py
- [ ] Test all endpoints with Postman/curl

**Deliverable**: Working backend API for chat

---

### Day 5: Frontend Integration
- [ ] Create frontend/src/types/chat.ts
  - [ ] ChatMessage interface
  - [ ] ChatResponse interface
  - [ ] ChatRequest interface
- [ ] Update frontend/src/lib/api.ts
  - [ ] Add api.chat.sendMessage()
  - [ ] Add api.chat.getHistory()
  - [ ] Add api.chat.submitFeedback()
  - [ ] Add api.chat.clearHistory()
  - [ ] Proper TypeScript types
  - [ ] Error handling
- [ ] Update frontend/src/components/user/FinancialChatbot.tsx
  - [ ] Remove generatePersonalizedAdvice() function (lines 62-202)
  - [ ] Add conversationId state variable
  - [ ] Update handleSend() to call api.chat.sendMessage()
  - [ ] Store conversation_id from first response
  - [ ] Pass conversation_id to subsequent messages
  - [ ] Display error messages from API
  - [ ] Show response_time_ms in dev mode (console.log)
  - [ ] Update loading state with better messaging
  - [ ] Handle network errors with retry
- [ ] Add feedback buttons to assistant messages
  - [ ] Show üëç/üëé buttons on assistant messages
  - [ ] Call api.chat.submitFeedback() on click
  - [ ] Show "Thanks for feedback!" confirmation
  - [ ] Disable buttons after rating
- [ ] Test in browser with real user (user_bdb7b6912c0b)

**Deliverable**: Chat UI works end-to-end with API

---

### Day 6: Testing
- [ ] Create backend/tests/services/test_context_builder.py
  - [ ] Test with user who has transactions
  - [ ] Test with user who has no transactions
  - [ ] Test token counting and truncation
  - [ ] Test formatting methods
  - [ ] 90%+ code coverage
- [ ] Create backend/tests/services/test_llm_service.py
  - [ ] Test successful response
  - [ ] Test timeout handling
  - [ ] Test retry logic
  - [ ] Test API errors
  - [ ] Mock Anthropic API calls
- [ ] Create backend/tests/api/test_chat.py
  - [ ] Test POST /message with valid request
  - [ ] Test POST /message without consent (403)
  - [ ] Test POST /message with invalid user (404)
  - [ ] Test GET /history
  - [ ] Test DELETE /history
  - [ ] Test POST /feedback
  - [ ] Test conversation continuity (multi-turn)
- [ ] Manual testing with real scenarios
  - [ ] "How much did I spend on food this month?"
  - [ ] "What's my biggest spending category?"
  - [ ] "Why should I pay down my credit card?"
  - [ ] "Show me my subscriptions"
  - [ ] "Create a budget for me"
  - [ ] Multi-turn: "How much on dining?" ‚Üí "Where did I go most?"
  - [ ] Invalid: Empty message
  - [ ] Edge: New user with no transactions
- [ ] Run pytest and verify all tests pass
- [ ] Performance testing
  - [ ] Install locust or similar
  - [ ] Test with 50 concurrent users
  - [ ] Measure p50, p95, p99 response times
  - [ ] Verify p95 < 5s
  - [ ] Check for database bottlenecks

**Deliverable**: All tests passing, performance validated

---

### Day 7: Documentation & Polish
- [ ] Write backend/docs/api/chat.md
  - [ ] Document all endpoints
  - [ ] Request/response schemas
  - [ ] Error codes and meanings
  - [ ] Code examples (curl, Python, TypeScript)
- [ ] Update OpenAPI/Swagger spec
  - [ ] Add descriptions to all endpoints
  - [ ] Add examples
- [ ] Write backend/docs/deployment/chat_deployment.md
  - [ ] Environment variable setup
  - [ ] Database migration steps
  - [ ] API key configuration
  - [ ] Rollback procedures
  - [ ] Health checks
  - [ ] Troubleshooting guide
- [ ] Write docs/user/chatbot_user_guide.md
  - [ ] What questions can the chatbot answer?
  - [ ] Example questions
  - [ ] Privacy and data usage
  - [ ] FAQ
- [ ] Code review
  - [ ] Check for security issues
  - [ ] Verify no API keys in code
  - [ ] Review error handling
  - [ ] Check input validation
- [ ] Final polish
  - [ ] Remove console.log statements (except dev mode)
  - [ ] Clean up commented code
  - [ ] Verify code style consistent
  - [ ] Update .env.example with all new variables

**Deliverable**: Production-ready code with documentation

---

## Phase 1 Complete! ‚úÖ

### Success Criteria Checklist
- [ ] Can send message and receive LLM response
- [ ] Context includes user profile, transactions, signals, recommendations
- [ ] Multi-turn conversations maintain context
- [ ] Response time p95 < 5s
- [ ] All tests passing
- [ ] No security vulnerabilities
- [ ] Documentation complete
- [ ] Ready for demo/user testing

### Demo Script
1. Open chat window
2. Ask: "What's my financial status?"
   - Should see personalized summary with actual data
3. Ask: "How much did I spend on food?"
   - Should see accurate total with breakdown
4. Ask: "Why should I pay down my credit card?"
   - Should reference actual credit utilization signal
5. Rate response with üëç
6. Ask follow-up: "How can I save money on food?"
   - Should maintain context from previous question
7. Show conversation history
8. Start new conversation

---

## Next Steps (Phase 2)

Once Phase 1 is complete and validated:
- [ ] Advanced conversation memory
- [ ] Transaction search with natural language
- [ ] Spending comparisons
- [ ] Guardrails implementation
- [ ] Rate limiting
- [ ] OpenAI fallback

See TASKS_CHATBOT_LLM_UPGRADE.txt for Phase 2 details.

---

**Track Your Progress**: Check off items as you complete them!
**Estimated Time**: 40-50 hours (1 week full-time, 2 weeks part-time)
**Difficulty**: Medium (requires backend + frontend + LLM integration)

Good luck! üöÄ
